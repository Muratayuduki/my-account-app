<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <title>アカウント管理</title>
</head>
<body>
    <h1>アカウント情報を登録してください</h1>
    <form id="accountForm">
        <label for="accountType">アカウント種類:</label>
        <select id="accountType">
            <option value="email">メールアドレス</option>
            <option value="game">ゲームアカウント</option>
        </select>

        <label for="identifier">メールアドレス / ゲーム名:</label>
        <input type="text" id="identifier" required>

        <label for="password">パスワード:</label>
        <input type="password" id="password" required>

        <label for="usage">用途（ゲーム名など）:</label>
        <input type="text" id="usage">

        <label for="memo">メモ:</label>
        <textarea id="memo"></textarea>

        <label><input type="checkbox" id="pin"> 重要</label>

        <button type="submit">登録</button>
    </form>

    <input type="text" id="search" placeholder="検索..." oninput="updateAccountList()">

    <button onclick="exportData()">バックアップ</button>
    <input type="file" id="importFile" onchange="importData(event)">
    <label for="importFile" style="cursor:pointer;">復元</label>

    <div class="account-list" id="accountList">
        <h2>登録済みアカウント</h2>
    </div>

    <script>
        const secretKey = "my-secret-key";

        function encryptData(data) {
            return CryptoJS.AES.encrypt(JSON.stringify(data), secretKey).toString();
        }

        function decryptData(encryptedData) {
            try {
                const bytes = CryptoJS.AES.decrypt(encryptedData, secretKey);
                return JSON.parse(bytes.toString(CryptoJS.enc.Utf8));
            } catch (e) {
                return [];
            }
        }

        let storedData = localStorage.getItem("accounts");
        let accounts = storedData ? decryptData(storedData) : [];

        document.getElementById('accountForm').addEventListener('submit', function(event) {
            event.preventDefault();
            const type = document.getElementById('accountType').value;
            const identifier = document.getElementById('identifier').value;
            const password = document.getElementById('password').value;
            const usage = document.getElementById('usage').value;
            const memo = document.getElementById('memo').value;
            const pinned = document.getElementById('pin').checked;

            const encryptedPassword = encryptData(password);

            accounts.push({ type, identifier, password: encryptedPassword, usage, memo, pinned });
            updateAccountList();
            document.getElementById('accountForm').reset();
        });

        function updateAccountList() {
            const searchQuery = document.getElementById('search').value.toLowerCase();
            const accountList = document.getElementById('accountList');
            accountList.innerHTML = '<h2>登録済みアカウント</h2>';

            let filteredAccounts = accounts.filter(acc => 
                acc.identifier.toLowerCase().includes(searchQuery) ||
                acc.usage.toLowerCase().includes(searchQuery) ||
                acc.memo.toLowerCase().includes(searchQuery)
            );

            filteredAccounts.sort((a, b) => b.pinned - a.pinned);

            filteredAccounts.forEach((item, index) => {
                const decryptedPassword = decryptData(item.password);

                const accountItem = document.createElement('div');
                accountItem.className = 'account-item';
                accountItem.innerHTML = `
                    <div>
                        <strong>${item.type === "email" ? "メールアドレス:" : "ゲーム名:"}</strong> ${item.identifier} <br>
                        <strong>パスワード:</strong> <span id="password-${index}">●●●●●●</span>
                        <button onclick="togglePassword(${index}, '${decryptedPassword}')">表示</button> <br>
                        <strong>用途:</strong> ${item.usage || "なし"}<br>
                        <strong>メモ:</strong> ${item.memo || "なし"}
                    </div>
                    <div class="button-group">
                        <button onclick="copyText('${item.identifier}')">コピー</button>
                        <button onclick="copyText('${decryptedPassword}')">パスコピー</button>
                        <button onclick="togglePin(${index})">${item.pinned ? "ピン解除" : "ピン留め"}</button>
                        <button onclick="deleteAccount(${index})">削除</button>
                    </div>
                `;
                accountList.appendChild(accountItem);
            });
            localStorage.setItem("accounts", encryptData(accounts));
        }

        function togglePassword(index, decryptedPassword) {
            const passwordField = document.getElementById(`password-${index}`);
            passwordField.textContent = passwordField.textContent === "●●●●●●" ? decryptedPassword : "●●●●●●";
        }

        function copyText(text) {
            navigator.clipboard.writeText(text)
                .then(() => alert('コピーしました: ' + text))
                .catch(err => alert('コピーに失敗しました。'));
        }

        function deleteAccount(index) {
            if (confirm("このアカウントを削除しますか？")) {
                accounts.splice(index, 1);
                updateAccountList();
            }
        }

        function togglePin(index) {
            accounts[index].pinned = !accounts[index].pinned;
            updateAccountList();
        }

        function exportData() {
            const encryptedData = encryptData(accounts);
            const blob = new Blob([encryptedData], { type: "text/plain" });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "backup.txt";
            link.click();
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    accounts = decryptData(e.target.result);
                    updateAccountList();
                    alert("データを復元しました！");
                } catch (error) {
                    alert("復元に失敗しました。");
                }
            };
            reader.readAsText(file);
        }

        updateAccountList();
    </script>
</body>
</html>
